## 对node的理解

### 1. 架构

|  程序员编写的程序代码和核心库代码 |
|   C/C++ Binding  |   Addons      |
| V8 | libuv| c-ares| crypto| http|zlib|

应用程序层: 模块，代码，核心模块，用js编写的文件

C/C++Bindings: 胶水代码，将C/C++写的接口代码库暴露给核心模块调用

Addons: 自己需要编写的桥接第三方库文件

libuv: 用c编写的异步功能库, 负责运行时的事件循环, 一个线程池, 文件系统I/O, DNS网络I/O

其他底层库：提供了对操作系统底层功能的访问, 比如说网络, 压缩, 加密

### 2. 异步与事件驱动

主程序采用事件循环机制

耗时严重的I/O密集型任务交给libuv去从线程池中新建线程执行

### 3. V8工作流程

1. 编译js代码形成AST抽象语法树
2. 作用域分析
3. JIT转换成原生代码
4. 数据分析器进行监控分析，对频率高的代码进行尝试优化，如果优化结果不如之前，就会滚动原先的状态

番外：其他JS引擎

1. JSCore,微信小程序的引擎

### 4. JS数据类型底层

1. 使用句柄标识对象,实际内容是变长的,类型也不同,句柄固定大小

2. 除了少数数据直接储存外,大部分数据都被存储在堆中

3. 隐藏类

V8会将拥有相同属性的对象归为一组, 这些对象的属性在隐藏类中拥有相同的偏移, 同组对象将会共享这些信息
保存属性名和该属性在对象内存中的偏移值，下次访问对象属性的时候就先访问隐藏类，在隐藏类找到偏移值再在对象内存里根据偏移值查找

4. 索引属性和命名属性被存放在不同的数据结构中，遍历对象的时候会先遍历索引属性，按升序遍历，然后遍历命名属性，按插入顺序遍历

### 5. 生命周期
1. timer
setTimeout/setinterval

2. pending callback
上一阶段延迟每执行的callback

3. idle prepare
内部用途

4. poll 轮询
I/O轮询，适当时候会在这里阻塞

5. cheak
setImmediate

6. close callback

